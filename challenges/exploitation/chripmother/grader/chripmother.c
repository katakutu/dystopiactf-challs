#include <fcntl.h>
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <unistd.h>

int gcanary = 0x00000000;

void print_banner()
{
    puts("              _____ _          _       __  __       _   _                         ");
    puts("             / ____| |        (_)     |  \\/  |     | | | |                       ");
    puts("            | |    | |__  _ __ _ _ __ | \\  / | ___ | |_| |__   ___ _ __          ");
    puts("            | |    | '_ \\| '__| | '_ \\| |\\/| |/ _ \\| __| '_ \\ / _ \\ '__|    ");
    puts("            | |____| | | | |  | | |_) | |  | | (_) | |_| | | |  __/ |             ");
    puts("             \\_____|_| |_|_|  |_| .__/|_|  |_|\\___/ \\__|_| |_|\\___|_|         ");
    puts("                                | |                                               ");
    puts("                                |_|                                               ");
    puts("                                                                                  ");
    puts("****************************************************************************************");
    puts("* I am Chrip, Chirpy's mom's mom. Someone said she was too talkative, so I gagged her. *");
    puts("****************************************************************************************");
    fflush(stdout);
}

char *read_canary()
{
    char *canary;

    canary = malloc(sizeof(int) + 1);

    int fd = open("canary.txt", O_RDONLY);

    if (fd < 0) {
        puts("[-] ERROR: canary.txt not found");
        fflush(stdout);
        exit(0);
    }

    read(fd, canary, sizeof(int));
    *(canary + 5) = '\0';

    return canary;
}


void birdsay()
{
    int canary = *((int*)read_canary());
    char buf[20];
    char temp[2048];
    int ret = *((int*)&canary + 4);


    printf("What should I say? => ");
    fflush(stdout);

    fgets(temp, sizeof(temp), stdin);
    memcpy(buf, temp, strlen(temp)-1);

    if (canary != gcanary) {
        puts("[-] ERROR: BIRD ABUSE DETECTED. YOU'RE HORRIBLE. I'M NOTIFYING PETA!");
        fflush(stdout);
        exit(0);
    }

    if (*((int*)(&canary) + 4) != ret) {
        memcpy((void*)((int*)(&canary) + 4), (void*)&ret, 4);
        puts("[-] You overwrote the return address? How smart. However, you overlooked the fact that i'm smarter than you. Bye!");
        fflush(stdout);
        exit(0);
    }

    printf("[+] My address is %p, do come to visit. We can have a potato salad party.\n", &canary);
    fflush(stdout);
}

int main()
{
    gcanary = *((int*)read_canary());

    print_banner();

    birdsay();

    return 0;
}
