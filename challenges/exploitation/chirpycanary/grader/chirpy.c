#include <fcntl.h>
#include <stdlib.h>
#include <stdio.h>
#include <unistd.h>

int gcanary = 0x00000000;

void print_banner()
{
    puts(" _____ _     _                  _____                                    ");
    puts("/  __ | |   (_)                /  __ \\                                  ");
    puts("| /  \\| |__  _ _ __ _ __  _   _| /  \\/ __ _ _ __   __ _ _ __ _   _     ");
    puts("| |   | '_ \\| | '__| '_ \\| | | | |    / _` | '_ \\ / _` | '__| | | |   ");
    puts("| \\__/| | | | | |  | |_) | |_| | \\__/| (_| | | | | (_| | |  | |_| |    ");
    puts(" \\____|_| |_|_|_|  | .__/ \\__, |\\____/\\__,_|_| |_|\\__,_|_|   \\__, |");
    puts("                   | |     __/ |                              __/ |      ");
    puts("                   |_|    |___/                              |___/       ");
    puts("                                                                         ");
    puts("*************************************************************************");
    puts("*  Hello, I am Chirpy! Although I am a Canary, I'm a parrot in training *");
    puts("*************************************************************************");
    fflush(stdout);
}

char *read_canary()
{
    char *canary;

    canary = malloc(sizeof(int) + 1);

    int fd = open("canary.txt", O_RDONLY);

    if (fd < 0) {
        puts("[-] ERROR: canary.txt not found");
        exit(0);
    }

    read(fd, canary, sizeof(int));
    *(canary + 5) = '\0';

    return canary;
}


void birdsay()
{
    int canary = *((int*)read_canary());
    char buf[20];

    printf("What should I say? => ");
    fflush(stdout);

    read(0, buf, 999);
    fflush(stdin);

    if (canary != gcanary) {
        puts("[-] ERROR: BIRD ABUSE DETECTED. YOU'RE HORRIBLE. I'M NOTIFYING PETA!");
        fflush(stdout);
        exit(0);
    } else {
        printf("[+] Chirpy says: %s\n", buf);
        fflush(stdout);
    }
}

int main()
{
    gcanary = *((int*)read_canary());

    print_banner();

    birdsay();

    return 0;
}
